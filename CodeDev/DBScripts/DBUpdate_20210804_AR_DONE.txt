create view vwPurchaseOrderTotalVAT
as
select
POI.PurchaseOrderID,
SUM(isnull(POI.VatValue,0) * poi.QtyRequired) 'TotalVAT'
from PurchaseOrderItem POI
group by POI.PurchaseOrderID
GO

create view vwPurchaseOrderTotalRetention
as
select
POI.PurchaseOrderID,
SUM(isnull(POI.RetentionValue,0)) 'TotalRetentionValue'
from PurchaseOrderItem POI
group by POI.PurchaseOrderID
GO


ALTER View [dbo].[vwPurchaseOrder]    AS
SELECT
PO.PurchaseOrderID,
PO.PONum,
PO.PaymentMethod,
PO.FileName,
PO.AccoutingCategoryID,
po.ValuationMode,
PO.PaymentDate,
SupplierContactTel,
MaterialRequirementTypeID,
PO.DefaultCurrency,
PO.POStage,
RefMatType,
Category,
SubmissionDate,
Status,
DelStatus,
Instructions,
Comments,
BuyerID,
RetentionPercentage,
AcknowledgementNo,
ExchangeRateValue,
OrderType,
Carriage,
VatRate,
RequiredDate,
PurchaseCategory,
CoCOrder,
CoCType,
PriceGross,
TotalPrice,
S.AccountCode,
S.isBigTaxPayer,
s.BankName,
DeliveryAddress1,
DeliveryAddress2,
DeliveryAddress3,
DeliveryTown,
DeliveryCounty,
DeliveryPostCode,
SupplierRef,
LastStatusChangeDate,
PaymentStatus,
TotalNetValue,
Concat(EM.FirstName,' ', EM.LastName) AS BuyerName,
CompanyName,

vwPOTVAT.TotalVAT,
vwPOTRetention.TotalRetentionValue

FROM PurchaseOrder PO

Left Join Supplier S ON PO.SupplierID = S.SupplierID
LEFT JOIN Employee EM ON EM.EmployeeID=PO.BuyerID
left join vwPurchaseOrderTotalVAT vwPOTVAT on vwPOTVAT.PurchaseOrderID=PO.PurchaseOrderID
LEFT JOIN vwPurchaseOrderTotalRetention vwPOTRetention on vwPOTRetention.PurchaseOrderID=po.PurchaseOrderID
GO


