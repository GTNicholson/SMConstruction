CREATE FUNCTION FnGetProjectsPurchaseOrder(@PurchaseOrderID int)
returns VARCHAR(1000)
AS   
BEGIN  
    DECLARE @RetVal varchar(1000);  

	SET @RETVAL= STUFF(
				(
					SELECT '-' + so.ProjectName 
					FROM SalesOrderPhaseItem SOPI
					INNER JOIN SalesOrder SO ON SO.SalesOrderID=SOPI.SalesOrderID
					WHERE SalesOrderPhaseItemID IN (
					SELECT DISTINCT POIA.SalesorderPhaseItemID FROM PurchaseOrderItemAllocation POIA
					INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID AND POI.PurchaseOrderID=@PurchaseOrderID
					) OR SalesOrderPhaseItemID IN (
					SELECT DISTINCT WOA.SalesorderPhaseItemID FROM WorkOrderAllocation WOA
					INNER JOIN PurchaseOrderItemAllocation POIA ON POIA.SalesOrderPhaseItemID=WOA.SalesOrderPhaseItemID
					INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID AND POI.PurchaseOrderID=@PurchaseOrderID

					)
					
					FOR XML PATH('')
				),1,1,'')
    RETURN @RetVal;  
END; 
GO

ALTER View [dbo].[vwPurchaseOrder]    AS
SELECT
PO.PurchaseOrderID,
PO.PONum,
PO.PaymentMethod,
PO.FileName,
PO.AccoutingCategoryID,
po.ValuationMode,
PO.PaymentDate,
SupplierContactTel,
MaterialRequirementTypeID,
MaterialRequirementTypeWorkOrderID,
PO.DefaultCurrency,
PO.POStage,
RefMatType,
Category,
SubmissionDate,
Status,
DelStatus,
Instructions,
Comments,
BuyerID,
RetentionPercentage,
AcknowledgementNo,
ExchangeRateValue,
OrderType,
Carriage,
VatRate,
RequiredDate,
PurchaseCategory,
CoCOrder,
CoCType,
PriceGross,
TotalPrice,
S.AccountCode,
S.isBigTaxPayer,
s.BankName,
DeliveryAddress1,
DeliveryAddress2,
DeliveryAddress3,
DeliveryTown,
DeliveryCounty,
DeliveryPostCode,
SupplierRef,
LastStatusChangeDate,
PaymentStatus,
TotalNetValue,
Concat(EM.FirstName,' ', EM.LastName) AS BuyerName,
CompanyName,

vwPOTVAT.TotalVAT,
vwPOTRetention.TotalRetentionValue,

dbo.FnGetProjectsPurchaseOrder(PO.PurchaseOrderID) 'Proyecto'




FROM PurchaseOrder PO

Left Join Supplier S ON PO.SupplierID = S.SupplierID
LEFT JOIN Employee EM ON EM.EmployeeID=PO.BuyerID
left join vwPurchaseOrderTotalVAT vwPOTVAT on vwPOTVAT.PurchaseOrderID=PO.PurchaseOrderID
LEFT JOIN vwPurchaseOrderTotalRetention vwPOTRetention on vwPOTRetention.PurchaseOrderID=po.PurchaseOrderID
GO

