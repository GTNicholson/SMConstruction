alter table MaterialRequirement
add GeneratedQty decimal (10,4)
go

create view vwOrderedQuantitySOPSummary
as
Select vwPOIAI.CallOffID,vwPOIAI.stockitemid, Sum(Quantity-ReceivedQty) as OrderedQty 
from vwPurchaseOrderItemAllocationInfo vwPOIAI
where vwPOIAI.POStatus not in (4,6) and IsNull(vwPOIAI.StockItemID,0)>0
group by vwPOIAI.CallOffID,vwPOIAI.StockItemID
GO



ALTER view [dbo].[vwMaterialRequirementPicking]
as

select 

MR.MaterialRequirementID,
MR.StockCode,
MR.Description,
MR.Quantity,
isnull(MR.PickedQty,0) as 'PickedQty',
MR.NetLenght,
MR.NetWidth,
MR.UoM,
MR.AreaID,
MR.SupplierStockCode,
MR.Comments,
MR.MaterialRequirementType,
MR.FromStockQty,
SI.Category,
SI.PartNo,
SI.StockItemID,
SI.StockCode AS 'STOCKITEMCODE',
SI.Description AS 'SIDESCRIPTION',
SI.AverageCost,
SI.StdCost,
WO.WorkOrderID,
WO.WorkOrderNo,
WO.Description as 'WODESCRIPTION',
WO.PlannedDeliverDate,
WO.PlannedStartDate,
WO.DateCreated,
WO.PurchasingDate,
SO.OrderNo,
SO.ProjectName,
CU.CompanyName,
WOA.WorkOrderAllocationID,
SOPI.SalesOrderPhaseID,
SOPI.SalesOrderPhaseItemID,
SOPI.SalesOrderID,
SOI.ItemNumber,
SOI.Description 'SOIDescription',
SOI.SalesOrderItemID,
isnull(MR.Quantity,0)-isnull(PickedQty,0) AS 'OSQty',
isnull(sil.Qty,0) StockItemLocationsQty,
isnull(vwOQSOP.OrderedQty,0) OrderedQty



from MaterialRequirement MR

inner join stockitem si on si.StockItemID=MR.StockItemID 
INNER JOIN WorkOrder WO ON WO.WorkOrderID=MR.ObjectID AND WO.Status not in (2,3)
LEFT join WorkOrderAllocation WOA on WOA.WorkOrderID=WO.WorkOrderID
LEFT JOIN StockItemLocation SIL ON SIL.StockItemID=SI.StockItemID
LEFT JOIN SalesOrderPhaseItem SOPI ON SOPI.SalesOrderPhaseItemID=WOA.SalesOrderPhaseItemID --IT'S INNER JOIN HERE
left join vwOrderedQuantitySOPSummary vwOQSOP on vwOQSOP.CallOffID=SOPI.SalesOrderPhaseID and vwOQSOP.StockItemID=si.StockItemID
LEFT JOIN SalesOrderItem SOI on SOI.SalesOrderItemID=SOPI.SalesItemID
LEFT JOIN SalesOrder SO ON SO.SalesOrderID=SOI.SalesOrderID
LEFT JOIN Customer CU ON CU.CustomerID = SO.CustomerID

WHERE MR.MaterialRequirementType IN (2,1)

GO



