CREATE VIEW vwTotalWOCompleteValue
as

select
SO.SalesOrderID,
SUM(ISNULL(MR.Quantity,0) * ISNULL(SI.AverageCost,0)) TotalWOCompleteValue
from MaterialRequirement MR
INNER JOIN WorkOrder WO ON WO.WorkOrderID=MR.ObjectID and WO.Status=2 --Complete
INNER JOIN StockItem SI ON SI.StockItemID=MR.StockItemID
INNER JOIN WorkOrderAllocation WOA ON WOA.WorkOrderID=WO.WorkOrderID
INNER JOIN SalesOrderPhaseItem SOPI ON SOPI.SalesOrderPhaseItemID=WOA.SalesOrderPhaseItemID
INNER JOIN SalesOrder SO ON SO.SalesOrderID=SOPI.SalesOrderID
GROUP BY SO.SalesOrderID
go

CREATE VIEW vwTotalWOInProcessValue
as

select
SO.SalesOrderID,
SUM(ISNULL(MR.Quantity,0) * ISNULL(SI.AverageCost,0)) TotalWOCompleteValue
from MaterialRequirement MR
INNER JOIN WorkOrder WO ON WO.WorkOrderID=MR.ObjectID and WO.Status not in (0,2,3) --Complete
INNER JOIN StockItem SI ON SI.StockItemID=MR.StockItemID
INNER JOIN WorkOrderAllocation WOA ON WOA.WorkOrderID=WO.WorkOrderID
INNER JOIN SalesOrderPhaseItem SOPI ON SOPI.SalesOrderPhaseItemID=WOA.SalesOrderPhaseItemID
INNER JOIN SalesOrder SO ON SO.SalesOrderID=SOPI.SalesOrderID
GROUP BY SO.SalesOrderID
go

ALTER view [dbo].[vwOrderedQuantityWOSummary]
as
Select 
POIA.WorkOrderID,
POI.StockItemID, 
Sum(Quantity-ReceivedQty) as OrderedQty,
Sum(ReceivedQty) as ReceivedQty 

from PurchaseOrderItemAllocation POIA
INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID
INNER JOIN PurchaseOrder PO ON PO.PurchaseOrderID=POI.PurchaseOrderID
group by POIA.WorkOrderID,POI.StockItemID
GO

ALTER view [dbo].[vwMaterialRequirementPicking]
as

select 

MR.MaterialRequirementID,
MR.StockCode,
MR.Description,
MR.Quantity,
MR.ReturnQty,
isnull(MR.PickedQty,0) as 'PickedQty',
MR.NetLenght,
MR.NetWidth,
MR.UoM,
MR.AreaID,
MR.SupplierStockCode,
MR.Comments,
MR.MaterialRequirementType,
MR.FromStockQty,
SI.Category,
SI.PartNo,
SI.StockItemID,
SI.StockCode AS 'STOCKITEMCODE',
SI.Description AS 'SIDESCRIPTION',
SI.AverageCost,
SI.StdCost,
WO.WorkOrderID,
WO.WorkOrderNo,
WO.Description as 'WODESCRIPTION',
WO.PlannedDeliverDate,
WO.PlannedStartDate,
WO.DateCreated,
WO.PurchasingDate,
SO.OrderNo,
SO.ProjectName,
CU.CompanyName,
WOA.WorkOrderAllocationID,
SOPI.SalesOrderPhaseID,
SOPI.SalesOrderPhaseItemID,
SOPI.SalesOrderID,
SOI.ItemNumber,
SOI.Description 'SOIDescription',
SOI.SalesOrderItemID,
isnull(MR.Quantity,0)-isnull(PickedQty,0) AS 'OSQty',
isnull(sil.Qty,0) StockItemLocationsQty,
isnull(vwOQWOSum.OrderedQty,0) OrderedQty,
isnull(vwOQWOSum.ReceivedQty,0) ReceivedQty



from MaterialRequirement MR

inner join stockitem si on si.StockItemID=MR.StockItemID 
INNER JOIN WorkOrder WO ON WO.WorkOrderID=MR.ObjectID AND WO.Status not in (3)
LEFT join WorkOrderAllocation WOA on WOA.WorkOrderID=WO.WorkOrderID
LEFT JOIN StockItemLocation SIL ON SIL.StockItemID=SI.StockItemID
LEFT JOIN SalesOrderPhaseItem SOPI ON SOPI.SalesOrderPhaseItemID=WOA.SalesOrderPhaseItemID --IT'S INNER JOIN HERE
left join vwOrderedQuantityWOSummary vwOQWOSum on vwOQWOSum.WorkOrderID=WO.WorkOrderID and vwOQWOSum.StockItemID=si.StockItemID
LEFT JOIN SalesOrderItem SOI on SOI.SalesOrderItemID=SOPI.SalesItemID
LEFT JOIN SalesOrder SO ON SO.SalesOrderID=SOI.SalesOrderID
LEFT JOIN Customer CU ON CU.CustomerID = SO.CustomerID

WHERE MR.MaterialRequirementType IN (2,1)

GO



ALTER view [dbo].[vwOrderedQuantityWOSummary]
as
Select 
POIA.WorkOrderID,
POI.StockItemID, 
Sum(POIA.Quantity-ReceivedQty) as OrderedQty,
Sum(ReceivedQty-poia.Quantity) as ReceivedQty 

from PurchaseOrderItemAllocation POIA
INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID
INNER JOIN PurchaseOrder PO ON PO.PurchaseOrderID=POI.PurchaseOrderID
where POI.StockItemID=12739
group by POIA.WorkOrderID,POI.StockItemID

GO


ALTER view [dbo].[vwOrderedQuantityWOSummary]
as
Select 
POIA.WorkOrderID,
POI.StockItemID, 
Sum(POIA.Quantity-ReceivedQty) as OrderedQty,
Sum(ReceivedQty) as ReceivedQty,
Sum(POIA.Quantity) as CurrentOrderQty 


from PurchaseOrderItemAllocation POIA
INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID
INNER JOIN PurchaseOrder PO ON PO.PurchaseOrderID=POI.PurchaseOrderID
where POI.StockItemID=12739
group by POIA.WorkOrderID,POI.StockItemID

GO


ALTER view [dbo].[vwMaterialRequirementPicking]
as

select 

MR.MaterialRequirementID,
MR.StockCode,
MR.Description,
MR.Quantity,
MR.ReturnQty,
isnull(MR.PickedQty,0) as 'PickedQty',
MR.NetLenght,
MR.NetWidth,
MR.UoM,
MR.AreaID,
MR.SupplierStockCode,
MR.Comments,
MR.MaterialRequirementType,
MR.FromStockQty,
SI.Category,
SI.PartNo,
SI.StockItemID,
SI.StockCode AS 'STOCKITEMCODE',
SI.Description AS 'SIDESCRIPTION',
SI.AverageCost,
SI.StdCost,
WO.WorkOrderID,
WO.WorkOrderNo,
WO.Description as 'WODESCRIPTION',
WO.PlannedDeliverDate,
WO.PlannedStartDate,
WO.DateCreated,
WO.PurchasingDate,
SO.OrderNo,
SO.ProjectName,
CU.CompanyName,
WOA.WorkOrderAllocationID,
SOPI.SalesOrderPhaseID,
SOPI.SalesOrderPhaseItemID,
SOPI.SalesOrderID,
SOI.ItemNumber,
SOI.Description 'SOIDescription',
SOI.SalesOrderItemID,
isnull(MR.Quantity,0)-isnull(PickedQty,0) AS 'OSQty',
isnull(sil.Qty,0) StockItemLocationsQty,
isnull(vwOQWOSum.OrderedQty,0) OrderedQty,
isnull(vwOQWOSum.ReceivedQty,0) ReceivedQty,
isnull(vwOQWOSum.CurrentOrderQty,0) CurrentOrderQty



from MaterialRequirement MR

inner join stockitem si on si.StockItemID=MR.StockItemID 
INNER JOIN WorkOrder WO ON WO.WorkOrderID=MR.ObjectID AND WO.Status not in (3)
LEFT join WorkOrderAllocation WOA on WOA.WorkOrderID=WO.WorkOrderID
LEFT JOIN StockItemLocation SIL ON SIL.StockItemID=SI.StockItemID
LEFT JOIN SalesOrderPhaseItem SOPI ON SOPI.SalesOrderPhaseItemID=WOA.SalesOrderPhaseItemID --IT'S INNER JOIN HERE
left join vwOrderedQuantityWOSummary vwOQWOSum on vwOQWOSum.WorkOrderID=WO.WorkOrderID and vwOQWOSum.StockItemID=si.StockItemID
LEFT JOIN SalesOrderItem SOI on SOI.SalesOrderItemID=SOPI.SalesItemID
LEFT JOIN SalesOrder SO ON SO.SalesOrderID=SOI.SalesOrderID
LEFT JOIN Customer CU ON CU.CustomerID = SO.CustomerID

WHERE MR.MaterialRequirementType IN (2,1)

GO



ALTER view [dbo].[vwOrderedQuantityWOSummary]
as
Select 
POIA.WorkOrderID,
POI.StockItemID, 
Sum(POIA.Quantity-ReceivedQty) as OrderedQty,
Sum(ReceivedQty) as ReceivedQty,
Sum(poi.QtyRequired) as CurrentOrderQty 


from PurchaseOrderItemAllocation POIA
INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID
INNER JOIN PurchaseOrder PO ON PO.PurchaseOrderID=POI.PurchaseOrderID
group by POIA.WorkOrderID,POI.StockItemID

GO


ALTER view [dbo].[vwOrderedQuantityWOSummary]
as
Select 
POIA.WorkOrderID,
POI.StockItemID, 
Sum(POIA.Quantity-ReceivedQty) as OrderedQty,
Sum(ReceivedQty) as ReceivedQty,
Sum(POIA.Quantity) as CurrentOrderQty 


from PurchaseOrderItemAllocation POIA
INNER JOIN PurchaseOrderItem POI ON POI.PurchaseOrderItemID=POIA.PurchaseOrderItemID
INNER JOIN PurchaseOrder PO ON PO.PurchaseOrderID=POI.PurchaseOrderID
group by POIA.WorkOrderID,POI.StockItemID

GO